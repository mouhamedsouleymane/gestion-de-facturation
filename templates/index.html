{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}

<!-- Dashboard Header -->
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h2 fw-bold mb-0"><i class="fas fa-file-invoice-dollar me-2 text-primary"></i>{% trans 'Invoices Dashboard' %}</h1>
        <p class="text-muted mt-1">{% trans 'Manage and track all your invoices' %}</p>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'add-invoice' %}" class="btn btn-primary btn-lg">
          <i class="fas fa-plus me-2"></i>{% trans 'New Invoice' %}
        </a>
        <a href="{% url 'add-customer' %}" class="btn btn-outline-primary btn-lg">
          <i class="fas fa-user-plus me-2"></i>{% trans 'New Customer' %}
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
  <div class="col-md-6 col-lg-3">
    <div class="card stat-card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <p class="text-muted mb-1">{% trans 'Total Invoices' %}</p>
            <h3 class="fw-bold mb-0">{{ total_invoices }}</h3>
          </div>
          <div class="stat-icon bg-primary">
            <i class="fas fa-file-invoice"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-3">
    <div class="card stat-card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <p class="text-muted mb-1">{% trans 'Paid Invoices' %}</p>
            <h3 class="fw-bold mb-0 text-success">{{ paid_invoices }}</h3>
          </div>
          <div class="stat-icon bg-success">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-3">
    <div class="card stat-card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <p class="text-muted mb-1">{% trans 'Pending Invoices' %}</p>
            <h3 class="fw-bold mb-0 text-warning">{{ total_invoices|add:paid_invoices|add:'-'|add:paid_invoices }}</h3>
          </div>
          <div class="stat-icon bg-warning">
            <i class="fas fa-clock"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6 col-lg-3">
    <div class="card stat-card border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <p class="text-muted mb-1">{% trans 'Completion Rate' %}</p>
            <h3 class="fw-bold mb-0">
              {% if total_invoices > 0 %}
                {{ paid_invoices|mul:100|div:total_invoices|floatformat:0 }}%
              {% else %}
                0%
              {% endif %}
            </h3>
          </div>
          <div class="stat-icon bg-info">
            <i class="fas fa-chart-pie"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="input-group">
          <span class="input-group-text bg-light border-0">
            <i class="fas fa-search text-muted"></i>
          </span>
          <input id="search" type="text" class="form-control form-control-lg border-0 bg-light" 
                 placeholder="{% trans 'Search by customer name, invoice ID, or date...' %}">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Invoices Table -->
<div class="row">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-bottom">
        <h5 class="mb-0 fw-bold"><i class="fas fa-list me-2 text-primary"></i>{% trans 'Recent Invoices' %}</h5>
      </div>
      <div class="card-body p-0">
        {% if invoices %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th class="fw-bold">{% trans 'ID' %}</th>
                <th class="fw-bold">{% trans 'Customer' %}</th>
                <th class="fw-bold">{% trans 'Date' %}</th>
                <th class="fw-bold">{% trans 'Total' %}</th>
                <th class="fw-bold">{% trans 'Status' %}</th>
                <th class="fw-bold">{% trans 'Type' %}</th>
                <th class="fw-bold text-center">{% trans 'Actions' %}</th>
              </tr>
            </thead>
            <tbody id="myTable">
              {% for facture in invoices %}
              <tr class="align-middle">
                <td>
                  <span class="badge bg-light text-dark">#{{ facture.pk }}</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 36px; height: 36px;">
                      <i class="fas fa-user"></i>
                    </div>
                    <div>
                      <p class="mb-0 fw-500">{{ facture.customer.name }}</p>
                      <small class="text-muted">{{ facture.customer.email }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <small class="text-muted">{{ facture.invoice_date_time|date:"d/m/Y H:i" }}</small>
                </td>
                <td>
                  <span class="fw-bold">{{ facture.get_total }} FCFA</span>
                </td>
                <td>
                  {% if facture.paid %}
                  <span class="badge bg-success-light text-success">
                    <i class="fas fa-check-circle me-1"></i>{% trans 'Paid' %}
                  </span>
                  {% else %}
                  <span class="badge bg-warning-light text-warning">
                    <i class="fas fa-hourglass-half me-1"></i>{% trans 'Pending' %}
                  </span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-info">{{ facture.get_invoice_type_display }}</span>
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <a href="{% url 'view-invoice' pk=facture.pk %}" class="btn btn-outline-primary" title="{% trans 'View' %}">
                      <i class="fas fa-eye"></i>
                    </a>
                    <a href="{% url 'invoice-pdf' pk=facture.pk %}" class="btn btn-outline-success" title="{% trans 'Download PDF' %}">
                      <i class="fas fa-download"></i>
                    </a>
                    <button type="button" class="btn btn-outline-warning btn-invoice-mod" data-bs-toggle="modal" data-bs-target="#modifyModal" 
                            data-id="{{ facture.pk }}" title="{% trans 'Modify' %}">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-invoice-del" data-bs-toggle="modal" data-bs-target="#deleteModal" 
                            data-id="{{ facture.pk }}" title="{% trans 'Delete' %}">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if invoices.has_other_pages %}
        <div class="card-footer bg-light border-top">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
              {% if invoices.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1"><i class="fas fa-chevron-left"></i> {% trans 'First' %}</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ invoices.previous_page_number }}">{% trans 'Previous' %}</a>
              </li>
              {% endif %}

              {% for page_number in invoices.paginator.page_range %}
              {% if invoices.number == page_number %}
              <li class="page-item active">
                <span class="page-link">{{ page_number }}</span>
              </li>
              {% else %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a>
              </li>
              {% endif %}
              {% endfor %}

              {% if invoices.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ invoices.next_page_number }}">{% trans 'Next' %}</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ invoices.paginator.num_pages }}">{% trans 'Last' %} <i class="fas fa-chevron-right"></i></a>
              </li>
              {% endif %}
            </ul>
          </nav>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-5">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <p class="text-muted">{% trans 'No invoices found. Create your first invoice!' %}</p>
          <a href="{% url 'add-invoice' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>{% trans 'Create Invoice' %}
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modify Invoice Modal -->
<div class="modal fade" id="modifyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-edit me-2"></i>{% trans 'Update Invoice Status' %}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{% url 'update-invoice-status' pk=0 %}">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" name="invoice_id" id="invoice_id">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="paidCheckbox" name="paid">
            <label class="form-check-label" for="paidCheckbox">
              {% trans 'Mark as Paid' %}
            </label>
          </div>
          <div class="mt-3">
            <label for="comments" class="form-label">{% trans 'Comments' %}</label>
            <textarea class="form-control" id="comments" name="comments" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
          <button type="submit" class="btn btn-primary">{% trans 'Save Changes' %}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Invoice Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-trash me-2"></i>{% trans 'Delete Invoice' %}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>{% trans 'Are you sure you want to delete this invoice? This action cannot be undone.' %}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
        <form method="post" style="display: inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">{% trans 'Delete' %}</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Search functionality
  const searchInput = document.getElementById('search');
  const tableRows = document.querySelectorAll('#myTable tr');
  
  searchInput.addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    tableRows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
  });

  // Modify button handler
  document.querySelectorAll('.btn-invoice-mod').forEach(btn => {
    btn.addEventListener('click', function() {
      document.getElementById('invoice_id').value = this.dataset.id;
    });
  });

  // Delete button handler
  document.querySelectorAll('.btn-invoice-del').forEach(btn => {
    btn.addEventListener('click', function() {
      const invoiceId = this.dataset.id;
      const form = document.querySelector('#deleteModal form');
      form.action = `/invoices/${invoiceId}/delete/`;
    });
  });
});
</script>

{% endblock %}
